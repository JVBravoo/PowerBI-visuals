<!--
***********************************************************************************************
Microsoft.TypeScript.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your web deploy projects from the command-line or the IDE.

This file defines the steps in the standard build process for TypeScript files.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(ScopasMSBuildExtensions)\Scopas.CSharp.targets" />

  <PropertyGroup>
    <OutputPath Condition=" '$(OutputPath)' == '' ">bin</OutputPath>
    <ScopasAutoBinplaceTarget>false</ScopasAutoBinplaceTarget>

    <TypeScriptPath>$(INFONAV_TOOLS)\TypeScript</TypeScriptPath>
    <UglifyJsPath>$(INFONAV_TOOLS)\UglifyJs</UglifyJsPath>
    <TsLintPath>$(INFONAV_TOOLS)\TsLint</TsLintPath>
  </PropertyGroup>

  <UsingTask TaskName="TypeScript.Tasks.VsTsc" AssemblyFile="$(TypeScriptPath)\TypeScript.tasks.dll" />
  <UsingTask TaskName="Microsoft.InfoNav.Build.Tasks.TsLint" AssemblyFile="$(INFONAV_TOOLS)\BuildTasks\Microsoft.InfoNav.Build.Tasks.dll"/>

  <PropertyGroup>
    <TypeScriptEnabled>true</TypeScriptEnabled>
  </PropertyGroup>


  <PropertyGroup Condition="'$(TypeScriptBuildConfigurations)' == ''">
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptRemoveComments)' == 'true'">$(TypeScriptBuildConfigurations) --removeComments</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptNoImplicitAny)' == 'true'">$(TypeScriptBuildConfigurations) --noImplicitAny</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptGeneratesDeclarations)' == 'true'">$(TypeScriptBuildConfigurations) --declaration</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptModuleKind)' != '' and '$(TypeScriptModuleKind)' != 'none'">$(TypeScriptBuildConfigurations) --module $(TypeScriptModuleKind)</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations>$(TypeScriptBuildConfigurations) --out &quot;$(ScopasProjectObjectPath)$(AssemblyName).js&quot;</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptOutDir)' != ''">$(TypeScriptBuildConfigurations) --outDir &quot;$(TypeScriptOutDir)&quot;</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptSourceMap)' == 'true'">$(TypeScriptBuildConfigurations) --sourcemap</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptTarget)' != ''">$(TypeScriptBuildConfigurations) --target $(TypeScriptTarget)</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptNoResolve)' == 'true'">$(TypeScriptBuildConfigurations) --noResolve</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptAdditionalFlags)' != ''">$(TypeScriptBuildConfigurations) $(TypeScriptAdditionalFlags)</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptMapRoot)' != '' And '$(TypeScriptSourceMap)' == 'true'">$(TypeScriptBuildConfigurations) --mapRoot &quot;$(TypeScriptMapRoot)&quot;</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptSourceRoot)' != '' And '$(TypeScriptSourceMap)' == 'true'">$(TypeScriptBuildConfigurations) --sourceRoot &quot;$(TypeScriptSourceRoot)&quot;</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptSourceRoot)' == '' And '$(TypeScriptSourceMap)' == 'true'">$(TypeScriptBuildConfigurations) --sourceRoot &quot;/&quot;</TypeScriptBuildConfigurations>
    <TypeScriptBuildConfigurations Condition="'$(TypeScriptCodePage)' != ''">$(TypeScriptBuildConfigurations) --codepage $(TypeScriptCodePage)</TypeScriptBuildConfigurations>
  </PropertyGroup>

  <PropertyGroup>
    <TypeScriptArgsFile>$(ScopasProjectObjectPath)__typeScriptArgs.txt</TypeScriptArgsFile>
    <TypeScriptToolsVersion Condition="'$(TypeScriptToolsVersion)'==''">1.0</TypeScriptToolsVersion>
    
    <TypeScriptExec Condition="'$(TypeScriptUseLegacyCompiler)'==''">$(TypeScriptPath)\node $(TypeScriptPath)\tsc.js</TypeScriptExec>
    <TypeScriptExec Condition="'$(TypeScriptUseLegacyCompiler)'=='true'">$(TypeScriptPath)\node $(TypeScriptPath)\tsc-legacy.js</TypeScriptExec>
  </PropertyGroup>

  <PropertyGroup>
    <UglifyJsMinifier>$(TypeScriptPath)\node $(UglifyJsPath)\bin\uglifyjs.js</UglifyJsMinifier>
    <TsLinter>$(TypeScriptPath)\node $(TsLintPath)\bin\tslint-cli.js</TsLinter>
    <TsLintRulesJson>$(TsLintPath)\tslint.json</TsLintRulesJson>
  </PropertyGroup>

  <PropertyGroup>
    <TypeScriptDebugOutputFile>$(ScopasProjectObjectPath)$(AssemblyName).js</TypeScriptDebugOutputFile>
    <TypeScriptMinifiedOutputFile>$(ScopasProjectObjectPath)$(AssemblyName).min.js</TypeScriptMinifiedOutputFile>
    <TypeScriptSourceMapFile>$(ScopasProjectObjectPath)$(AssemblyName).js.map</TypeScriptSourceMapFile>
    <TypeScriptMinifiedSourceMapFile>$(ScopasProjectObjectPath)$(AssemblyName).min.js.map</TypeScriptMinifiedSourceMapFile>
  </PropertyGroup>

  <ItemGroup>
    <TypeScriptCompileTargetOutputs Include="$(TypeScriptDebugOutputFile)" />
    <TypeScriptCompileTargetOutputs Include="$(TypeScriptSourceMapFile)" Condition="'$(TypeScriptSourceMap)' == 'true'" />
    
    <Minify Include="$(TypeScriptDebugOutputFile)" />
    <MinifyTargetOutputs Include="$(TypeScriptMinifiedOutputFile)" />
    <MinifyTargetOutputs Include="$(TypeScriptMinifiedSourceMapFile)" Condition="'$(TypeScriptSourceMap)' == 'true'" />

    <ScopasBinplace Include="@(TypeScriptCompileTargetOutputs);@(MinifyTargetOutputs)">
      <DestinationFolder>$(TypeScriptBinaryDropPath)</DestinationFolder>
    </ScopasBinplace>
  </ItemGroup>

  <ItemGroup>
    <TypeScriptCompileTargetOutputs Include="$(TypeScriptDebugOutputFile)" />
    <TypeScriptCompileTargetOutputs Include="$(TypeScriptSourceMapFile)" Condition="'$(TypeScriptSourceMap)' == 'true'" />
    <MinifyTargetOutputs Include="$(TypeScriptMinifiedOutputFile)" />
    <MinifyTargetOutputs Include="$(TypeScriptMinifiedSourceMapFile)" Condition="'$(TypeScriptSourceMap)' == 'true'" />
  </ItemGroup>
  
  <Target Name="TypeScriptLint" BeforeTargets="TypeScriptCompile" Inputs="@(TypeScriptCompile)" Outputs="@(TypeScriptCompileTargetOutputs)" Condition="'$(TypeScriptLintingEnabled)' == 'true'">
    <TsLint TsSourceFiles="@(TypeScriptCompile)" TsLintRulesJson="$(TsLintRulesJson)" />
  </Target>

  <Target Name="TypeScriptCompile" BeforeTargets="Minify" Inputs="@(TypeScriptCompile)" Outputs="@(TypeScriptCompileTargetOutputs)">
    <Delete Files="$(TypeScriptArgsFile)" />
    <WriteLinesToFile File="$(TypeScriptArgsFile)" Lines="@(TypeScriptCompile ->'&quot;%(fullpath)&quot;', ' ')" />
    <Exec ContinueOnError="False" Command="$(TypeScriptExec) $(TypeScriptBuildConfigurations) %40$(TypeScriptArgsFile)">
        <Output TaskParameter="ExitCode" PropertyName="ErrorCode" />
    </Exec>
    <Delete Files="$(TypeScriptDebugOutputFile);$(TypeScriptSourceMapFile)" Condition="'$(ErrorCode)' == '1'" />
    <Error Text="Typescript Build Failed" Condition="'$(ErrorCode)' == '1'" />
    <Delete Files="$(TypeScriptArgsFile)" />
  </Target>

  <Target Name="Minify" AfterTargets="TypeScriptCompile" BeforeTargets="ScopasPrepareForBinplace" Inputs="@(Minify)" Outputs="@(MinifyTargetOutputs)" Condition=" '@(Minify)' != '' ">
    <PropertyGroup>
        <AjaxMinifierSourceMapOptions Condition="'$(TypeScriptSourceMap)' == 'true'">-map:v3 $(TypeScriptMinifiedSourceMapFile)</AjaxMinifierSourceMapOptions>
        <UglifyJsMinifierSourceMapOptions Condition="'$(TypeScriptSourceMap)' == 'true'">--prefix relative --in-source-map $(TypeScriptSourceMapFile) --source-map $(TypeScriptMinifiedSourceMapFile) --source-map-root &quot;$(TypeScriptSourceRoot)&quot;</UglifyJsMinifierSourceMapOptions>
    </PropertyGroup>
    
    <Exec Condition="'$(UseUglifyJsMinifier)' != 'true'" Command="$(SQL_AJAX_MINIFIER) -silent -JS -clobber:True -term @(Minify, ' ') -out $(TypeScriptMinifiedOutputFile) $(AjaxMinifierSourceMapOptions)" />
    <Exec Condition="'$(UseUglifyJsMinifier)' == 'true'" Command="$(SQL_UGLIFYJS_MINIFIER) @(Minify, ' ') --screw-ie8 -c pure_funcs=['debug.assertValue','debug.assertFail','debug.assert'] -m --define DEBUG=false --output $(TypeScriptMinifiedOutputFile) $(UglifyJsMinifierSourceMapOptions)" />
  </Target>
  
</Project>

